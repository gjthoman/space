<!doctype html>
<meta charset="utf-8">
<title>Hello World</title>
<style>* {padding: 0; margin: 0}</style>
<body>
<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
<script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
<script src="pixi.min.js"></script>
<script src="pixicam.min.js"></script>

<script>
    var ref = new Firebase('https://sizzling-fire-3063.firebaseio.com/');
    var shipID;
    var shipRef;
    var objects = {};
    var objectsRef = ref.child("ship");
    var enemies = [];
    
    objectsRef.on("value", function(snapshot) {
      objects = snapshot.val();
    }, function (errorObject) {
      console.log("The read failed: " + errorObject.code);
    });
    
	var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite;
    var ship, loop;
    var mousePos = {};
    var graveyard = [];
    var mouseThrottle;
    var bullets = [];
    
    var worldDimension = 1000;
    
    var Bullet = function(x, y, radians, speed) {
        var sprite;
        var init = function(){
            sprite = new Sprite(resources["plasma.png"].texture);

            sprite.anchor.x = 0.5;
            sprite.anchor.y = 0.5;
            sprite.rotation = radians;

            sprite.position.set(x, y);
            
            world.addChild(sprite);
        }
        
        var update = function(){
            if ( x < 0 || y < 0 || x > worldDimension || y > worldDimension) {
                var i = bullets.indexOf(this);
                bullets.splice(i, 1);
                
                graveyard.push(this);
            }
            
            x = sprite.x += speed.x;
            y = sprite.y += speed.y;
            
        }
        
        var destroy = function() {
            world.removeChild(sprite);
            //sprite.destroy(true);
        }
        
        var height = function(){
            return sprite.height;
        }
        
        var width = function(){
            return sprite.width;
        }
        var position = function() {
            return {
                x: x,
                y: y
            }
        }
        
        init();
        
        return {
            update: update,
            position: position,
            destroy: destroy,
            height: height,
            width: width
        }
    }
    
    var Enemy = function(key, data) {
        var sprite;
        var key = key;
        var x,y;
        var init = function(){
            sprite = new Sprite(resources["enemy.png"].texture);

            sprite.anchor.x = 0.5;
            sprite.anchor.y = 0.5;
            sprite.rotation = data.r;

            sprite.position.set(data.x, data.y);
            
            world.addChild(sprite);
        }
        
        var update = function(data){
            if ( data.x < 0 || data.y < 0 || data.x > worldDimension || data.y > worldDimension) {
                var i = enemy.indexOf(this);
                enemy.splice(i, 1);
                
                graveyard.push(this);
            }
            
            x = sprite.x = data.x;
            y = sprite.y = data.y;
            sprite.rotation = data.r;
            
        }
        
        var destroy = function() {
            world.removeChild(sprite);
        }
        
        var height = function(){
            return sprite.height;
        }
        
        var width = function(){
            return sprite.width;
        }
        var position = function() {
            return {
                x: data.x,
                y: data.y
            }
        }
        
        init();
        
        return {
            update: update,
            position: position,
            destroy: destroy,
            height: height,
            width: width,
            key: key
        }
    }
    
    var Ship = function(player){
        var pos = {
            x: worldDimension/2,
            y: worldDimension/2
        }
        var velocity = {
            x: 0,
            y: 0
        }
        var sprite;
        var scale = 1;
        var thrust = 0.5;
        var isThrusting = false;
        var rads;
        var init = function(){
            sprite = new Sprite(resources["ship.png"].texture);
            sprite.scale.x = sprite.scale.y = scale;
            sprite.anchor.x = 0.5;
            sprite.anchor.y = 0.5;

            sprite.position.set(pos.x, pos.y);
            
            world.addChild(sprite);
            
            setupListeners();
        }
        var update = function(){
            var dx = mousePos.x - window.innerWidth/2;
            var dy = mousePos.y - window.innerHeight/2;
            rads = Math.atan2(dy, dx);

            if(isThrusting){
                velocity.x += Math.cos(rads) * thrust;
                velocity.y += Math.sin(rads) * thrust;
            }
            
            velocity.x *= 0.99;
            velocity.y *= 0.99;

            sprite.rotation = rads;
            
            pos.x = sprite.x += velocity.x;
            pos.y = sprite.y += velocity.y;
        }
        var setupListeners = function() {
            if (player) {
                $(document).on('keydown', function(e) {
                    switch (e.keyCode) {
                        case 32:
                            isThrusting = true;
                        break;
                        case 70:
                            bullets.push(new Bullet(pos.x, pos.y, rads, {
                                x:Math.cos(rads) * 20 + velocity.x, 
                                y:Math.sin(rads) * 20 + velocity.y
                            }));
                        break;
                    }
                });

                $(document).on('keyup', function(e) {
                    switch (e.keyCode) {
                        case 32:
                            isThrusting = false;
                        break;
                    }
                });
            }
        }
        var radians = function(){
            return rads;
        }
        var handleCollision = function(){
            sprite.tint = 0xFF0000;
            setTimeout(function(){
                sprite.tint = 0xFFFFFF;
            }, 250);
        }
        
        init();
        
        return {
            pos: pos,
            update: update,
            position: pos,
            handleCollision:handleCollision,
            sprite: sprite,
            radians: radians
        }
    }

    var stage = new Container(),
        renderer = autoDetectRenderer(256, 256, {antialias: false});
        renderer.view.style.position = "absolute";
        renderer.view.style.display = "block";
        renderer.autoResize = true;
        renderer.resize(window.innerWidth, window.innerHeight);

    var world = new pixicam.World({
        screenWidth: window.innerWidth,
        screenHeight: window.innerHeight,
        width: worldDimension,
        height: worldDimension,
        x: worldDimension/2,
        y: worldDimension/2
    });

    var camera = world.camera;
    var instructions = new PIXI.Text('Use space to thrust.', {fill:'#CCCCCC'});
 
    instructions.x = 20;
    instructions.y = 20;
    instructions.scale.x = instructions.scale.y = .5;
    
    stage.addChild(instructions);
 
    stage.addChild(world);
    
    document.body.appendChild(renderer.view);

    loader.add("ship.png").add("plasma.png").add("tile.png").add("enemy.png").load(setup);

    function setup() {
        loop = setInterval(function(){ update(); }, 30);
        
        var frame = PIXI.Texture.fromFrame("tile.png");
        var tiling = new PIXI.extras.TilingSprite(frame, worldDimension, worldDimension);
        tiling.alpha = 0.25;
        
        var graphics = new PIXI.Graphics();

        //graphics.beginFill(0xFFFF00);
        
        graphics.lineStyle(5, 0xFF0000);

        // draw a rectangle
        graphics.drawRect(0, 0, worldDimension, worldDimension);

        world.addChild(graphics);

        world.addChild(tiling);
        ship = new Ship(true);
        
        shipRef = objectsRef.push({
            x:ship.pos.x,
            y:ship.pos.y,
            r:0
        });
        
        shipID = shipRef.key();
        
        stage.addChild(instructions);
        
        setupListeners();
    }
    
    function setupListeners() {
        mouseThrottle = false;
        
        $(document).mousemove(function(e){
            if (mouseThrottle) { return };
            mouseThrottle = true;
            mousePos = {
                x: e.pageX,
                y: e.pageY
            }
            setTimeout(function(){mouseThrottle = false;}, 30);
        });
    }
    
    function update(){
        ship.update();
        
        if (bullets.length > 0) {
            bullets.forEach(function(bullet){
                bullet.update(); 
            });
        }
        
        camera.x = ship.pos.x;
        camera.y = ship.pos.y;

        world.update();
        renderer.render(stage);
        
        shipRef.update({x:ship.pos.x, y:ship.pos.y, r:ship.radians()||0});
        
        delete objects[shipID];
        
        if (enemies.length > 0) {
            enemies.forEach(function(enemy){
                if(objects[enemy.key]) {
                    enemy.update(objects[enemy.key]);
                    //delete objects[enemy.key];
                } else {
                    enemy.destroy();
                }
            });
        }
        
        for (var key in objects) {
            if (objects.hasOwnProperty(key)) {
                var data = objects[key];
                var enemy = new Enemy(key, data);
                    
                enemies.push(enemy);
            }
        }
        
        if( graveyard.length > 0) {
            graveyard.forEach(function(body){
                body.destroy(); 
            });
            graveyard = [];
        }
        
        CollisionManager();
    }
    
    window.onbeforeunload = function() {
       shipRef.remove();
    }
    
    Math.radians = function(degrees) {
        return degrees * Math.PI / 180;
    };

    Math.degrees = function(radians) {
        return radians * 180 / Math.PI;
    };
    
    CollisionManager = function(){
        for (var i = 0; i < bullets.length; i++) 	{
            var bullet = bullets[i];		
            var xdist = bullet.position().x - ship.position.x;
            
            if(xdist > -bullet.width() && xdist < bullet.width()){
                var ydist = bullet.position().y - ship.position.y;
            
                if(ydist > -bullet.height() && ydist < bullet.height()){
                    ship.handleCollision();
                }		
            }	
        }
    }
</script>
</body>
<!doctype html>
<meta charset="utf-8">
<title>Hello World</title>
<style>* {padding: 0; margin: 0}</style>
<body>
<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>

<script src="pixi.min.js"></script>
<script src="pixicam.min.js"></script>

<script>
	var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite;
    var ship, loop;
    var mousePos = {};
    var graveyard = [];
    var mouseThrottle;
    var bullets = [];
    
    var Bullet = function(x, y, radians, speed) {
        var sprite;
        var init = function(){
            sprite = new Sprite(resources["plasma.png"].texture);

            sprite.anchor.x = 0.5;
            sprite.anchor.y = 0.5;
            sprite.rotation = radians;

            sprite.position.set(x, y);
            
            world.addChild(sprite);
        }
        
        var update = function(){
            if ( x < 0 || y < 0 || x > 5000 || y > 5000) {
                var i = bullets.indexOf(this);
                bullets.splice(i, 1);
                
                graveyard.push(this);
            }
            
            x = sprite.x += speed.x;
            y = sprite.y += speed.y;
            
        }
        
        var destroy = function() {
            world.removeChild(sprite);
            //sprite.destroy(true);
        }
        
        var height = function(){
            return sprite.height;
        }
        
        var width = function(){
            return sprite.width;
        }
        var position = function() {
            return {
                x: x,
                y: y
            }
        }
        
        init();
        
        return {
            update: update,
            position: position,
            destroy: destroy,
            height: height,
            width: width
        }
    }
    
    var Ship = function(){
        var pos = {
            x: 2500,
            y: 2500
        }
        var velocity = {
            x: 0,
            y: 0
        }
        var sprite;
        var scale = 1;
        var thrust = 0.5;
        var isThrusting = false;
        var radians = 0;
        var init = function(){
            sprite = new Sprite(resources["ship.png"].texture);
            sprite.scale.x = sprite.scale.y = scale;
            sprite.anchor.x = 0.5;
            sprite.anchor.y = 0.5;

            sprite.position.set(pos.x, pos.y);
            
            world.addChild(sprite);
            
            setupListeners();
        }
        var update = function(){
            var dx = mousePos.x - window.innerWidth/2;
            var dy = mousePos.y - window.innerHeight/2;
            radians = Math.atan2(dy, dx);

            if(isThrusting){
                velocity.x += Math.cos(radians) * thrust;
                velocity.y += Math.sin(radians) * thrust;
            }
            
            velocity.x *= 0.99;
            velocity.y *= 0.99;

            sprite.rotation = radians;
            
            pos.x = sprite.x += velocity.x;
            pos.y = sprite.y += velocity.y;
        }
        var setupListeners = function() {
            $(document).on('keydown', function(e) {
                switch (e.keyCode) {
                    case 32:
                        isThrusting = true;
                    break;
                    case 70:
                        bullets.push(new Bullet(pos.x, pos.y, radians, {
                            x:Math.cos(radians) * 20 + velocity.x, 
                            y:Math.sin(radians) * 20 + velocity.y
                        }));
                    break;
                }
            });

            $(document).on('keyup', function(e) {
                switch (e.keyCode) {
                    case 32:
                        isThrusting = false;
                    break;
                }
            });
        }
        var handleCollision = function(){
            sprite.tint = 0xFF0000;
            setTimeout(function(){
                sprite.tint = 0xFFFFFF;
            }, 250);
        }
        
        init();
        
        return {
            pos: pos,
            update: update,
            position: pos,
            handleCollision:handleCollision,
            sprite: sprite
        }
    }

    var stage = new Container(),
        renderer = autoDetectRenderer(256, 256, {antialias: false});
        renderer.view.style.position = "absolute";
        renderer.view.style.display = "block";
        renderer.autoResize = true;
        renderer.resize(window.innerWidth, window.innerHeight);

    var world = new pixicam.World({
        screenWidth: window.innerWidth,
        screenHeight: window.innerHeight,
        width: 5000,
        height: 5000,
        x: 2500,
        y: 2500
    });

    var camera = world.camera;
    var instructions = new PIXI.Text('Use space to thrust.', {fill:'#CCCCCC'});
 
    instructions.x = 20;
    instructions.y = 20;
    instructions.scale.x = instructions.scale.y = .5;
    
    stage.addChild(instructions);
 
    stage.addChild(world);
    
    document.body.appendChild(renderer.view);

    loader.add("ship.png").add("plasma.png").add("tile.png").load(setup);

    function setup() {
        loop = setInterval(function(){ update(); }, 30);
        
        var frame = PIXI.Texture.fromFrame("tile.png");
        var tiling = new PIXI.extras.TilingSprite(frame, 5000, 5000);
        tiling.alpha = 0.25;
        
        var graphics = new PIXI.Graphics();

        //graphics.beginFill(0xFFFF00);
        
        graphics.lineStyle(5, 0xFF0000);

        // draw a rectangle
        graphics.drawRect(0, 0, 5000, 5000);

        world.addChild(graphics);

        world.addChild(tiling);
        ship = new Ship();
        
        stage.addChild(instructions);
        
        setupListeners();
    }
    
    function setupListeners() {
        mouseThrottle = false;
        
        $(document).mousemove(function(e){
            if (mouseThrottle) { return };
            mouseThrottle = true;
            mousePos = {
                x: e.pageX,
                y: e.pageY
            }
            setTimeout(function(){mouseThrottle = false;}, 30);
        });
    }
    
    function update(){
        ship.update();
        
        if (bullets.length > 0) {
            bullets.forEach(function(bullet){
                bullet.update(); 
            });
        }
        
        camera.x = ship.pos.x;
        camera.y = ship.pos.y;

        world.update();
        renderer.render(stage);
        
        CollisionManager();
        
        if( graveyard.length > 0) {
            graveyard.forEach(function(body){
                body.destroy(); 
            });
            graveyard = [];
        }
    }
    
    Math.radians = function(degrees) {
        return degrees * Math.PI / 180;
    };

    Math.degrees = function(radians) {
        return radians * 180 / Math.PI;
    };
    
    CollisionManager = function(){
        for (var i = 0; i < bullets.length; i++) 	{
            var bullet = bullets[i];		
            var xdist = bullet.position().x - ship.position.x;
            
            if(xdist > -bullet.width() && xdist < bullet.width()){
                var ydist = bullet.position().y - ship.position.y;
            
                if(ydist > -bullet.height() && ydist < bullet.height()){
                    ship.handleCollision();
                }		
            }	
        }
    }
</script>
</body>